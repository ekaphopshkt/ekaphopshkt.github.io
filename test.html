<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ราคา ETH Real-time</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Thai characters -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Kanit font to the whole page */
        body {
            font-family: 'Kanit', sans-serif;
        }
        /* Custom animation for the price pulse effect */
        @keyframes pulse-light {
            0%, 100% { text-shadow: 0 0 5px rgba(52, 211, 153, 0.5); }
            50% { text-shadow: 0 0 20px rgba(52, 211, 153, 1); }
        }
        .price-pulse { animation: pulse-light 2s infinite; }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- Main container card -->
    <div class="w-full max-w-lg p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 text-center">

        <!-- Header section -->
        <div class="flex items-center justify-center mb-4">
            <img src="https://s2.coinmarketcap.com/static/img/coins/64x64/1027.png" alt="Ethereum Logo" class="w-12 h-12 mr-4" onerror="this.onerror=null;this.src='https://placehold.co/64x64/1f2937/ffffff?text=ETH';">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-100">ราคา Ethereum (ETH)</h1>
        </div>
        <p class="text-gray-400 mb-2">ข้อมูล Real-time จาก Binance (ETH/USDT)</p>
        <div id="btc-trend-container" class="text-sm text-gray-400 mb-4 h-5"></div>

        <!-- Price display section -->
        <div id="price-container" class="bg-gray-900/50 p-6 rounded-xl border border-gray-600">
            <p class="text-5xl font-bold my-4 text-gray-400 price-pulse" id="eth-price">
                <span class="loader border-4 border-gray-500 rounded-full w-10 h-10 inline-block"></span>
            </p>
            <p id="last-updated" class="text-sm text-gray-500 h-4">กำลังเชื่อมต่อ...</p>
        </div>

        <!-- Tab Navigation -->
        <div class="mt-6">
            <div class="border-b border-gray-700">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-dashboard" class="border-purple-500 text-purple-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Dashboard
                    </button>
                    <button id="tab-trading-room" class="border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Trading Room
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="content-dashboard">
            <!-- My Portfolio Section -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200 mb-4">พอร์ตของฉัน</h2>
                <div class="space-y-3 sm:space-y-0 sm:flex sm:items-center sm:space-x-2 mb-4">
                    <input type="number" id="eth-amount-input" placeholder="จำนวน ETH ที่ซื้อ" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="eth-price-input" placeholder="ราคาที่ซื้อ (USDT)" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="add-transaction-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">เพิ่ม</button>
                </div>
                <div class="grid grid-cols-2 gap-4 bg-gray-900/50 rounded-lg p-4">
                    <div>
                        <p class="text-sm text-gray-400">ETH ทั้งหมด</p>
                        <p id="portfolio-total-eth" class="font-bold text-lg">0.00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">ราคาเฉลี่ย (USDT)</p>
                        <p id="portfolio-avg-price" class="font-bold text-lg">0.00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">มูลค่าปัจจุบัน (THB)</p>
                        <p id="portfolio-current-value" class="font-bold text-lg">฿0.00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">กำไร/ขาดทุน (THB)</p>
                        <p id="portfolio-profit-loss" class="font-bold text-lg">฿0.00</p>
                    </div>
                </div>
                <button id="reset-portfolio-btn" class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-200 mt-4">ล้างพอร์ตทั้งหมด</button>
            </div>

            <!-- Target Price Analysis Section -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200 mb-4">วิเคราะห์ราคาเป้าหมาย</h2>
                <div class="space-y-3 sm:space-y-0 sm:flex sm:items-center sm:space-x-2 mb-4">
                    <input type="number" id="target-price-input" placeholder="ใส่ราคาเป้าหมาย (USDT)" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="analyze-target-btn" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">วิเคราะห์</button>
                </div>
                <div id="target-analysis-result" class="bg-gray-900/50 rounded-lg p-4 text-center min-h-[6rem] flex items-center justify-center">
                    <p class="text-gray-500">กรุณาใส่ราคาเป้าหมายเพื่อเริ่มการวิเคราะห์</p>
                </div>
            </div>

            <!-- Analysis Section -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200 mb-2">บทวิเคราะห์ทางเทคนิค (จำลอง)</h2>
                <p class="text-sm text-yellow-400 mb-4" id="prediction-timeframe">กรอบเวลาวิเคราะห์: 4-8 ชั่วโมงข้างหน้า</p>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-gray-900/50 p-3 rounded-lg">
                        <p class="text-sm text-green-400">แนวรับ (8 ชั่วโมง)</p>
                        <p id="support-level" class="font-bold text-lg">-</p>
                    </div>
                    <div class="bg-gray-900/50 p-3 rounded-lg">
                        <p class="text-sm text-red-400">แนวต้าน (8 ชั่วโมง)</p>
                        <p id="resistance-level" class="font-bold text-lg">-</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-gray-900/50 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">มุมมองข่าว</p>
                        <p id="news-sentiment" class="font-bold text-lg">-</p>
                    </div>
                    <div class="bg-gray-900/50 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">RSI (14)</p>
                        <p id="rsi-value" class="font-bold text-lg">-</p>
                    </div>
                    <div class="bg-gray-900/50 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">MACD</p>
                        <p id="macd-status" class="font-bold text-lg">-</p>
                    </div>
                    <div class="bg-gray-900/50 p-3 rounded-lg">
                        <p class="text-sm text-blue-400">KDJ</p>
                        <p id="kdj-value" class="font-bold text-lg">-</p>
                    </div>
                </div>
                <div class="bg-gray-900/50 p-3 rounded-lg">
                    <p class="text-sm text-purple-400">ราคาตั้งฐาน (KDJ)</p>
                    <p id="base-price" class="font-bold text-lg">-</p>
                </div>
            </div>

             <!-- Daily Price Range Prediction -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200 mb-4">คาดการณ์กรอบราคารายวัน (24 ชม.)</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-900/50 p-3 rounded-lg">
                        <p class="text-sm text-green-400">ราคาสูงสุดที่คาดการณ์</p>
                        <p id="daily-high-prediction" class="font-bold text-lg">-</p>
                    </div>
                    <div class="bg-gray-900/50 p-3 rounded-lg">
                        <p class="text-sm text-red-400">ราคาต่ำสุดที่คาดการณ์</p>
                        <p id="daily-low-prediction" class="font-bold text-lg">-</p>
                    </div>
                </div>
            </div>

            <!-- 15-Minute Prediction Section -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200 mb-4">คาดการณ์ราคา (15 นาที)</h2>
                <div id="short-term-prediction-card" class="bg-gray-900/50 rounded-lg p-4 text-left">
                    <div class="flex justify-between items-baseline mb-2 pb-2 border-b border-gray-700/50">
                        <span class="text-gray-400">ราคาปัจจุบัน</span>
                        <p id="current-price-in-prediction" class="text-2xl font-bold">-</p>
                    </div>
                    <div class="flex justify-between items-baseline">
                        <span class="text-gray-400">ราคาคาดการณ์</span>
                        <p id="short-term-prediction-price" class="text-2xl font-bold">-</p>
                    </div>
                    <p id="short-term-prediction-direction" class="text-sm text-center text-gray-400 mt-2">-</p>
                </div>
            </div>

            <!-- Recommendation Section -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200 mb-4">คำแนะนำทั่วไป (จำลอง)</h2>
                <div id="recommendation-card" class="p-5 rounded-lg border">
                    <p id="recommendation-text" class="text-2xl font-bold">-</p>
                    <p id="recommendation-reason" class="text-sm text-gray-400 mt-1">-</p>
                </div>
            </div>

            <!-- Smart Recommendation Section -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200 mb-4">คำแนะนำอัจฉริยะ (จำลอง)</h2>
                <div id="smart-recommendation-card" class="p-5 rounded-lg border border-purple-500/50 bg-purple-900/20">
                    <div id="smart-recommendation-loader">
                        <p class="text-sm text-gray-300 mb-2">กำลังรวบรวมข้อมูลเพื่อวิเคราะห์...</p>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div id="smart-rec-progress-bar" class="bg-purple-600 h-2.5 rounded-full transition-all duration-1000 ease-linear" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <p id="smart-rec-progress-text" class="text-sm text-gray-300">0%</p>
                            <p class="text-xs text-gray-500">
                                ตรวจสอบรอบถัดไปใน: <span id="smart-rec-countdown" class="font-bold text-yellow-400">--:--</span>
                            </p>
                        </div>
                    </div>
                    <div id="smart-recommendation-content" class="hidden">
                        <p id="smart-recommendation-accuracy" class="text-xs text-gray-400 mb-2"></p>
                        <div id="smart-recommendation-text-content">
                            <!-- Actual recommendation text will go here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bear Market Outlook Section -->
            <div id="bear-market-outlook-section" class="mt-6 pt-6 border-t border-gray-700 hidden">
                <h2 class="text-xl font-semibold text-gray-200 mb-4">คาดการณ์เมื่อตลาดเป็นหมี 🐻</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-red-900/30 p-4 rounded-lg border border-red-500/50">
                        <p class="text-sm text-red-300">หมีอาจตบไปถึง</p>
                        <p id="bear-target-price" class="font-bold text-2xl text-white">-</p>
                    </div>
                    <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/50">
                        <p class="text-sm text-green-300">กระทิงรอบถัดไปอาจขวิดไปที่</p>
                        <p id="bull-target-price" class="font-bold text-2xl text-white">-</p>
                    </div>
                </div>
            </div>

            <!-- Portfolio Recommendation Section -->
            <div id="portfolio-recommendation-section" class="mt-6 pt-6 border-t border-gray-700 hidden">
                <h2 class="text-xl font-semibold text-gray-200 mb-4">คำแนะนำสำหรับพอร์ตของคุณ</h2>
                <div id="portfolio-recommendation-card" class="p-5 rounded-lg border">
                    <p id="portfolio-recommendation-text" class="text-2xl font-bold">-</p>
                    <p id="portfolio-recommendation-reason" class="text-sm text-gray-400 mt-1 mb-4">-</p>
                    <div class="grid grid-cols-2 gap-4 text-left">
                        <div class="bg-gray-900/50 p-3 rounded-md">
                            <p class="text-sm text-green-400">เป้าหมายแนวต้านถัดไป</p>
                            <p id="upside-target" class="font-bold text-lg text-white">-</p>
                            <p id="upside-chance" class="text-xs text-gray-300">-</p>
                            <p id="upside-time-est" class="text-xs text-gray-400 mt-1">คาดว่าจะถึงใน: -</p>
                        </div>
                        <div class="bg-gray-900/50 p-3 rounded-md">
                            <p class="text-sm text-red-400">ความเสี่ยงที่แนวรับ</p>
                            <p id="downside-target" class="font-bold text-lg text-white">-</p>
                            <p id="downside-chance" class="text-xs text-gray-300">-</p>
                            <p id="downside-time-est" class="text-xs text-gray-400 mt-1">คาดว่าจะถึงใน: -</p>
                            <div id="next-support-levels-container" class="mt-2 pt-2 border-t border-gray-700/50 text-xs hidden">
                                <p class="text-gray-400">หากหลุดแนวรับนี้ แนวรับถัดไปคือ:</p>
                                <p id="next-supports-text" class="font-semibold text-white"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Road to ATH Section -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200 mb-4">เส้นทางสู่ All-Time High (ATH)</h2>
                <div class="bg-gray-900/50 rounded-lg p-4 text-left">
                    <div class="flex justify-between items-baseline mb-3 pb-3 border-b border-gray-700/50">
                        <span class="text-sm text-gray-400">All-Time High</span>
                        <span id="ath-price" class="font-bold text-lg text-yellow-300">-</span>
                    </div>
                    <div id="resistance-path-list" class="space-y-3">
                        <div class="text-center text-gray-500">กำลังคำนวณเส้นทาง...</div>
                    </div>
                </div>
            </div>
            
            <!-- External Analysis Check Section -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200 mb-4">ตรวจสอบกับแหล่งข้อมูลภายนอก (จำลอง)</h2>
                <div class="bg-gray-900/50 rounded-lg p-4 text-left">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-400">แหล่งข้อมูล:</span>
                        <span class="font-semibold">Financial Insights API</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-400">มุมมองล่าสุด:</span>
                        <span id="external-opinion" class="font-bold text-lg">-</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-400">สถานะ:</span>
                        <span id="external-status" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between items-center mt-3 pt-2 border-t border-gray-700/50">
                        <span class="text-xs text-gray-500">ตรวจสอบล่าสุด:</span>
                        <span id="external-last-checked" class="text-xs text-gray-500">-</span>
                    </div>
                </div>
            </div>

            <!-- Prediction Accuracy Section -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200 mb-4">ความแม่นยำในการคาดการณ์ (จำลอง)</h2>
                <div class="bg-gray-900/50 rounded-lg p-4 text-center">
                    <p class="text-5xl font-bold" id="prediction-accuracy-percent">-%</p>
                    <p class="text-gray-400" id="prediction-accuracy-stats">กำลังคำนวณ...</p>
                    <div id="prediction-history-list" class="mt-4 space-y-2 text-left">
                        <!-- History items will be injected here -->
                    </div>
                    <p class="text-xs text-gray-500 mt-4">
                        ตรวจสอบใหม่ใน: <span id="accuracy-countdown" class="font-bold text-yellow-400">--:--</span>
                    </p>
                </div>
            </div>
        </div>

        <div id="content-trading-room" class="hidden">
            <div class="mt-6 pt-6 border-t border-gray-700">
                <h2 class="text-2xl font-bold text-gray-100 mb-4">Trading Room (สัญญาณเข้าซื้อ)</h2>
                <div id="trading-room-signal-card" class="p-6 rounded-2xl border-2 min-h-[250px] flex flex-col items-center justify-center transition-all duration-500 border-gray-700">
                     <!-- Content is generated by JS -->
                </div>
            </div>
        </div>

        <p class="text-xs text-gray-600 mt-8">*ข้อมูลทั้งหมดเป็นการจำลองเพื่อการสาธิต ไม่ใช่คำแนะนำในการลงทุน</p>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm text-center border border-gray-600">
            <h3 id="modal-title" class="text-lg font-bold text-white mb-4">ยืนยันการดำเนินการ</h3>
            <p id="modal-body" class="text-gray-300 mb-6">คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลพอร์ตทั้งหมด?</p>
            <div class="flex justify-center space-x-4">
                <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition duration-200">ยกเลิก</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-md transition duration-200">ยืนยัน</button>
            </div>
        </div>
    </div>

    <script>
        const elements = {
            ethPrice: document.getElementById('eth-price'),
            lastUpdated: document.getElementById('last-updated'),
            btcTrendContainer: document.getElementById('btc-trend-container'),
            newsSentiment: document.getElementById('news-sentiment'),
            rsiValue: document.getElementById('rsi-value'),
            macdStatus: document.getElementById('macd-status'),
            kdjValue: document.getElementById('kdj-value'),
            basePrice: document.getElementById('base-price'),
            supportLevel: document.getElementById('support-level'),
            resistanceLevel: document.getElementById('resistance-level'),
            recommendationCard: document.getElementById('recommendation-card'),
            recommendationText: document.getElementById('recommendation-text'),
            recommendationReason: document.getElementById('recommendation-reason'),
            ethAmountInput: document.getElementById('eth-amount-input'),
            ethPriceInput: document.getElementById('eth-price-input'),
            addTransactionBtn: document.getElementById('add-transaction-btn'),
            resetPortfolioBtn: document.getElementById('reset-portfolio-btn'),
            portfolioTotalEth: document.getElementById('portfolio-total-eth'),
            portfolioAvgPrice: document.getElementById('portfolio-avg-price'),
            portfolioCurrentValue: document.getElementById('portfolio-current-value'),
            portfolioProfitLoss: document.getElementById('portfolio-profit-loss'),
            modal: document.getElementById('confirmation-modal'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn'),
            portfolioRecSection: document.getElementById('portfolio-recommendation-section'),
            portfolioRecCard: document.getElementById('portfolio-recommendation-card'),
            portfolioRecText: document.getElementById('portfolio-recommendation-text'),
            portfolioRecReason: document.getElementById('portfolio-recommendation-reason'),
            upsideTarget: document.getElementById('upside-target'),
            upsideChance: document.getElementById('upside-chance'),
            upsideTimeEst: document.getElementById('upside-time-est'),
            downsideTarget: document.getElementById('downside-target'),
            downsideChance: document.getElementById('downside-chance'),
            downsideTimeEst: document.getElementById('downside-time-est'),
            externalOpinion: document.getElementById('external-opinion'),
            externalStatus: document.getElementById('external-status'),
            externalLastChecked: document.getElementById('external-last-checked'),
            predictionAccuracyPercent: document.getElementById('prediction-accuracy-percent'),
            predictionAccuracyStats: document.getElementById('prediction-accuracy-stats'),
            accuracyCountdown: document.getElementById('accuracy-countdown'),
            predictionHistoryList: document.getElementById('prediction-history-list'),
            shortTermPredictionPrice: document.getElementById('short-term-prediction-price'),
            shortTermPredictionDirection: document.getElementById('short-term-prediction-direction'),
            currentPriceInPrediction: document.getElementById('current-price-in-prediction'),
            athPrice: document.getElementById('ath-price'),
            resistancePathList: document.getElementById('resistance-path-list'),
            nextSupportLevelsContainer: document.getElementById('next-support-levels-container'),
            nextSupportsText: document.getElementById('next-supports-text'),
            targetPriceInput: document.getElementById('target-price-input'),
            analyzeTargetBtn: document.getElementById('analyze-target-btn'),
            targetAnalysisResult: document.getElementById('target-analysis-result'),
            smartRecommendationLoader: document.getElementById('smart-recommendation-loader'),
            smartRecProgressBar: document.getElementById('smart-rec-progress-bar'),
            smartRecProgressText: document.getElementById('smart-rec-progress-text'),
            smartRecCountdown: document.getElementById('smart-rec-countdown'),
            smartRecommendationContent: document.getElementById('smart-recommendation-content'),
            smartRecommendationAccuracy: document.getElementById('smart-recommendation-accuracy'),
            smartRecommendationTextContent: document.getElementById('smart-recommendation-text-content'),
            tabDashboard: document.getElementById('tab-dashboard'),
            tabTradingRoom: document.getElementById('tab-trading-room'),
            contentDashboard: document.getElementById('content-dashboard'),
            contentTradingRoom: document.getElementById('content-trading-room'),
            tradingRoomSignalCard: document.getElementById('trading-room-signal-card'),
            dailyHighPrediction: document.getElementById('daily-high-prediction'),
            dailyLowPrediction: document.getElementById('daily-low-prediction'),
            bearMarketOutlookSection: document.getElementById('bear-market-outlook-section'),
            bearTargetPrice: document.getElementById('bear-target-price'),
            bullTargetPrice: document.getElementById('bull-target-price'),
        };

        let lastPrice = 0;
        let currentEthPrice = 0;
        let usdToThbRate = 36.7; // Default rate
        const commissionRate = 0.001; // 0.1% commission
        let transactions = [];
        let confirmAction = null; 
        let predictionHistory = [];
        let lastPredictionTimestamp = 0;
        let accuracyCountdownInterval;
        let historicalAllTimeData = null; // Cache for ATH data
        let currentAnalysisData = {}; // Cache for current analysis data


        // --- Modal Functions ---
        function showModal() { elements.modal.classList.remove('hidden'); }
        function hideModal() { elements.modal.classList.add('hidden'); confirmAction = null; }

        // --- Portfolio & Prediction History Functions ---
        function saveToLocalStorage(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
        function loadFromLocalStorage(key) {
            const savedData = localStorage.getItem(key);
            return savedData ? JSON.parse(savedData) : [];
        }


        function updatePortfolioDisplay() {
            if (transactions.length === 0) {
                 // Clear portfolio display but keep profit/loss updating
                elements.portfolioTotalEth.textContent = '0.00';
                elements.portfolioAvgPrice.textContent = '0.00';
                elements.portfolioRecSection.classList.add('hidden');
            } else {
                 elements.portfolioRecSection.classList.remove('hidden');
                const totalEth = transactions.reduce((sum, tx) => sum + tx.amountAfterFee, 0);
                const totalCost = transactions.reduce((sum, tx) => sum + tx.cost, 0);
                const avgPrice = totalEth > 0 ? totalCost / totalEth : 0;
                elements.portfolioTotalEth.textContent = totalEth.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
                elements.portfolioAvgPrice.textContent = avgPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            if (currentEthPrice > 0) {
                 const totalEth = transactions.reduce((sum, tx) => sum + tx.amountAfterFee, 0);
                 const totalCost = transactions.reduce((sum, tx) => sum + tx.cost, 0);
                 const currentValueUSD = totalEth * currentEthPrice;
                 const profitLossUSD = totalEth > 0 ? currentValueUSD - totalCost : 0;
                 const currentValueTHB = currentValueUSD * usdToThbRate;
                 const profitLossTHB = profitLossUSD * usdToThbRate;
                 elements.portfolioCurrentValue.textContent = '฿' + currentValueTHB.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                 elements.portfolioProfitLoss.textContent = '฿' + profitLossTHB.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                 elements.portfolioProfitLoss.className = `font-bold text-lg ${profitLossUSD >= 0 ? 'text-green-400' : 'text-red-400'}`;
            }
        }


        function handleAddTransaction() {
            const amount = parseFloat(elements.ethAmountInput.value);
            const price = parseFloat(elements.ethPriceInput.value);

            if (isNaN(amount) || isNaN(price) || amount <= 0 || price <= 0) {
                document.getElementById('modal-title').textContent = 'ข้อมูลไม่ถูกต้อง';
                document.getElementById('modal-body').textContent = 'กรุณาใส่จำนวนและราคาที่ถูกต้อง';
                document.getElementById('modal-confirm-btn').classList.add('hidden');
                document.getElementById('modal-cancel-btn').textContent = 'ปิด';
                showModal();
                confirmAction = () => { 
                    document.getElementById('modal-title').textContent = 'ยืนยันการดำเนินการ';
                    document.getElementById('modal-body').textContent = 'คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลพอร์ตทั้งหมด?';
                    document.getElementById('modal-confirm-btn').classList.remove('hidden');
                    document.getElementById('modal-cancel-btn').textContent = 'ยกเลิก';
                    hideModal();
                };
                return;
            }

            const cost = amount * price;
            const fee = amount * commissionRate;
            const amountAfterFee = amount - fee;

            transactions.push({ amountAfterFee: amountAfterFee, cost: cost });
            saveToLocalStorage('eth_transactions', transactions);
            updatePortfolioDisplay();
            elements.ethAmountInput.value = '';
            elements.ethPriceInput.value = '';
        }
        
        function handleResetPortfolio() {
            // Reset modal to its default confirmation state before showing
            document.getElementById('modal-title').textContent = 'ยืนยันการดำเนินการ';
            document.getElementById('modal-body').textContent = 'คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลพอร์ตทั้งหมด?';
            document.getElementById('modal-confirm-btn').classList.remove('hidden');
            document.getElementById('modal-cancel-btn').textContent = 'ยกเลิก';

            showModal();
            confirmAction = () => {
                transactions = [];
                localStorage.removeItem('eth_transactions');
                updatePortfolioDisplay();
                hideModal();
            };
        }

        // --- Technical Analysis Functions ---
        const calculateSMA = (p, period) => p.length < period ? 0 : p.slice(-period).reduce((a, b) => a + b, 0) / period;
        const calculateEMA = (prices, period) => {
             if (prices.length < period) return 0;
            const k = 2 / (period + 1);
            let ema = calculateSMA(prices.slice(0, period), period);
            for (let i = period; i < prices.length; i++) { ema = (prices[i] * k) + (ema * (1 - k)); }
            return ema;
        };
        const calculateRSI = (prices, period = 14) => {
             if (prices.length < period + 1) return 50;
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const diff = prices[i] - prices[i-1];
                if (diff >= 0) { gains += diff; } else { losses -= diff; }
            }
            if (losses === 0) return 100;
            const rs = (gains / period) / (losses / period);
            return (100 - (100 / (1 + rs)));
        };
        const calculateMACD = (p, s = 12, l = 26, sig = 9) => {
            if (p.length < l) return { macd: 0, signal: 0 };
            const m = calculateEMA(p, s) - calculateEMA(p, l);
            const sLine = calculateEMA(p.slice(-sig * 2), sig);
            return { macd: m, signal: sLine };
        };
        const calculateKDJ = (klines, n = 9, m1 = 3, m2 = 3) => {
            if (klines.length < n) return { k: 50, d: 50, j: 50, basePrice: 0 };
            let rsvs = [];
            for (let i = n - 1; i < klines.length; i++) {
                const period = klines.slice(i - n + 1, i + 1);
                const close = parseFloat(period[period.length - 1][4]);
                const lowestLow = Math.min(...period.map(k => parseFloat(k[3])));
                const highestHigh = Math.max(...period.map(k => parseFloat(k[2])));
                const rsv = (highestHigh === lowestLow) ? 50 : ((close - lowestLow) / (highestHigh - lowestLow)) * 100;
                rsvs.push(rsv);
            }
            let k = 50, d = 50;
            for (const rsv of rsvs) {
                k = (k * (m1 - 1) + rsv) / m1;
                d = (d * (m2 - 1) + k) / m2;
            }
            const j = 3 * k - 2 * d;
            let basePrice = 0;
            if (k < 30 && d < 30) { 
                 const period = klines.slice(-n);
                 basePrice = Math.min(...period.map(k => parseFloat(k[3])));
            }
            return { k, d, j, basePrice };
        };
        const calculateSR = (klines) => {
            if (!klines || klines.length === 0) return { support: 0, resistance: 0 };
            const lows = klines.map(k => parseFloat(k[3])); // Low price index
            const highs = klines.map(k => parseFloat(k[2])); // High price index
            const support = Math.min(...lows);
            const resistance = Math.max(...highs);
            return { support, resistance };
        };
         const calculateATR = (klines, period = 14) => {
            if (klines.length < period + 1) return 0;
            let trueRanges = [];
            for (let i = klines.length - period; i < klines.length; i++) {
                const high = parseFloat(klines[i][2]);
                const low = parseFloat(klines[i][3]);
                const prevClose = parseFloat(klines[i - 1][4]);
                const tr = Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose));
                trueRanges.push(tr);
            }
            return trueRanges.reduce((a, b) => a + b, 0) / period;
        };

        // --- Data Fetching ---
        const fetchData = async (url) => {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`Fetch failed for ${url}`);
            return res.json();
        }
        
        async function fetchAllTimeData() {
            if (historicalAllTimeData) return historicalAllTimeData;
            try {
                // Using weekly data for better granularity of major resistance levels
                const data = await fetchData(`https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1w&limit=1000`);
                historicalAllTimeData = data;
                return data;
            } catch (error) {
                console.error("Could not fetch all-time historical data:", error);
                return [];
            }
        }
        
        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json');
                const data = await response.json();
                if (data && data.usd && data.usd.thb) {
                    usdToThbRate = data.usd.thb;
                }
            } catch (error) {
                console.error("Could not fetch exchange rate, using default.", error);
            }
        }

        // --- Real-time Price via WebSocket ---
        function setupWebSocket() {
            const ws = new WebSocket('wss://stream.binance.com:9443/ws/ethusdt@ticker');
            ws.onopen = () => { elements.lastUpdated.textContent = 'เชื่อมต่อสำเร็จแล้ว'; elements.ethPrice.classList.remove('text-gray-400'); };
            ws.onmessage = (event) => {
                const price = parseFloat(JSON.parse(event.data).c);
                if (currentEthPrice === 0) {
                    elements.ethPrice.classList.add('text-green-400');
                    elements.currentPriceInPrediction.classList.add('text-gray-200');
                }
                if (price > lastPrice && lastPrice !== 0) { elements.ethPrice.className = 'text-5xl font-bold my-4 price-pulse text-green-400'; } 
                else if (price < lastPrice) { elements.ethPrice.className = 'text-5xl font-bold my-4 price-pulse text-red-400'; }
                lastPrice = price; currentEthPrice = price;
                elements.ethPrice.textContent = `$${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                elements.currentPriceInPrediction.textContent = `$${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                elements.lastUpdated.textContent = `อัปเดตล่าสุด: ${new Date().toLocaleTimeString('th-TH')}`;
                updatePortfolioDisplay();
            };
            ws.onerror = () => { elements.lastUpdated.textContent = 'การเชื่อมต่อขัดข้อง'; };
            ws.onclose = () => { elements.lastUpdated.textContent = 'การเชื่อมต่อถูกตัด'; };
        }
        
        // --- Analysis and Recommendation Logic ---
        function getGeneralRecommendation(rsi, isMacdBullish, isBtcBullish, newsScore, currentPrice, support, resistance) {
            let hold = 0, sell = 0;
            if (rsi > 70) sell += 2; else if (rsi > 60) sell += 1;
            else if (rsi < 30) hold += 2; else if (rsi < 40) hold += 1;
            if (isMacdBullish) hold += 1.5; else sell += 1.5;
            if (isBtcBullish) hold += 1; else sell += 1;
            hold += newsScore > 0 ? 1 : 0; sell += newsScore < 0 ? 1 : 0;
            if (support > 0 && resistance > 0) {
                const proximityToResistance = (resistance - currentPrice) / (resistance - support);
                if (proximityToResistance < 0.15) sell += 1.5;
                if (proximityToResistance > 0.85) hold += 1.5;
            }

            if (sell > hold + 1.5) {
                const reason = `ตลาดร้อนแรง รอขายทำกำไรที่แนวต้าน ~$${resistance.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
                return { text: 'พิจารณาขายทำกำไร', reason: reason, style: 'border-red-500/50 bg-red-900/30 text-red-300' };
            }
            if (hold > sell + 1.5) {
                const reason = `โมเมนตัมบวก รอซื้อเพิ่มที่แนวรับ ~$${support.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
                return { text: 'ถือต่อ / รอซื้อเพิ่ม', reason: reason, style: 'border-green-500/50 bg-green-900/30 text-green-300' };
            }
            return { text: 'ถือเพื่อรอดูสถานการณ์', reason: 'สัญญาณตลาดยังไม่ชัดเจน', style: 'border-yellow-500/50 bg-yellow-900/30 text-yellow-300' };
        }

        function getSmartRecommendation(analysisData, accuracy) {
            const loader = elements.smartRecommendationLoader;
            const content = elements.smartRecommendationContent;
            const { isBtcBullish, isMacdBullish, rsi, j, k, d, support, resistance, nextMajorResistance } = analysisData;
            
            if (accuracy === null || accuracy < 50) {
                loader.classList.remove('hidden');
                content.classList.add('hidden');
                return;
            }
            
            loader.classList.add('hidden');
            content.classList.remove('hidden');
            elements.smartRecommendationAccuracy.textContent = `ตรวจสอบจากความแม่นยำ: ${accuracy}%`;

            const hasPortfolio = transactions.length > 0;
            let recommendationHtml = '';

            // 1. Strong Buy Signal (KDJ Golden Cross)
            if (isBtcBullish && isMacdBullish && j > k && k > d && k < 60 && d < 50) {
                 const title = hasPortfolio ? "เกิดสัญญาณซื้อเพิ่มที่แข็งแกร่ง" : "เกิดสัญญาณเข้าซื้อที่แข็งแกร่ง";
                 recommendationHtml = `
                    <p class="text-2xl font-bold text-green-400">${title}</p>
                    <p class="text-sm text-gray-300 mt-1">
                        KDJ ส่งสัญญาณ Golden Cross ประกอบกับแนวโน้มตลาดยังดี เป็นโอกาสที่ดีในการเข้าซื้อ
                    </p>
                `;
            }
            // 2. "Don't sell yet" (ขายหมู)
            else if (hasPortfolio && isBtcBullish && isMacdBullish && rsi < 75 && k > d) {
                const targetPrice = nextMajorResistance > 0 ? nextMajorResistance : resistance * 1.05;
                recommendationHtml = `
                    <p class="text-2xl font-bold text-green-400">อย่าเพิ่งขาย! มีแนวโน้มขายหมู</p>
                    <p class="text-sm text-gray-300 mt-1">
                        โมเมนตัมตลาดยังแข็งแกร่ง ราคาอาจวิ่งไปต่อที่เป้าหมายถัดไปบริเวณ
                        <span class="font-bold text-white">~$${targetPrice.toLocaleString('en-US', {minimumFractionDigits: 0})}</span>
                    </p>
                `;
            }
            // 3. "Good to buy now"
            else if (isBtcBullish && rsi < 55 && k < 40 && d < 40) {
                 const title = hasPortfolio ? "เหมาะกับการซื้อเพิ่ม" : "ราคานี้เหมาะกับการเข้าซื้อ";
                 recommendationHtml = `
                    <p class="text-2xl font-bold text-green-400">${title}</p>
                    <p class="text-sm text-gray-300 mt-1">
                        ตลาดอยู่ในแนวโน้มที่ดีและราคามีการย่อตัวลงมา เป็นจังหวะที่ดีในการเก็บของ
                    </p>
                `;
            }
            // 4. "Wait to buy at support"
            else if (isBtcBullish && rsi > 60) {
                 const title = hasPortfolio ? "รอซื้อเพิ่มที่แนวรับ" : "รอซื้อที่แนวรับเพื่อเก็บของ";
                 recommendationHtml = `
                    <p class="text-2xl font-bold text-yellow-400">${title}</p>
                    <p class="text-sm text-gray-300 mt-1">
                        ตลาดยังดูดีแต่ราคาค่อนข้างสูง ควรรอให้ย่อตัวลงมาที่แนวรับ
                         <span class="font-bold text-white">~$${support.toLocaleString('en-US', {minimumFractionDigits: 0})}</span>
                    </p>
                `;
            }
            // Default message
            else {
                recommendationHtml = `<p class="text-gray-400">ยังไม่มีคำแนะนำที่ชัดเจนในขณะนี้</p>`;
            }

            elements.smartRecommendationTextContent.innerHTML = recommendationHtml;
        }

        function getTradingRoomSignal(analysisData) {
            const { isBtcBullish, isMacdBullish, rsi, j, k, d, support, nextSupportLevels } = analysisData;
            const card = elements.tradingRoomSignalCard;
            
            let signal = { active: false, type: '', price: 0, reason: '', confidence: 0 };

            // Trigger 1: Strong Market Buy (Momentum Play)
            const marketBuyConfidenceFactors = [ isBtcBullish, isMacdBullish, rsi > 50 && rsi < 70, j > k && k > d, j < 90 ];
            const marketBuyConfidence = (marketBuyConfidenceFactors.filter(Boolean).length / marketBuyConfidenceFactors.length) * 100;
            
            if (marketBuyConfidence >= 80) {
                signal = { active: true, type: 'MARKET', price: currentEthPrice, reason: 'เกิดสัญญาณ Golden Cross และโมเมนตัมตลาดเป็นบวก', confidence: Math.round(marketBuyConfidence) };
            }
            
            // Trigger 2: Limit Buy (Buy the Dip)
            if (!signal.active) {
                const limitBuyConfidenceFactors = [ isBtcBullish, rsi < 45, k < 30 && d < 40, Math.abs(currentEthPrice - support) / support < 0.015 ];
                const limitBuyConfidence = (limitBuyConfidenceFactors.filter(Boolean).length / limitBuyConfidenceFactors.length) * 100;
                if (limitBuyConfidence >= 75) {
                    signal = { active: true, type: 'LIMIT', price: support, reason: 'ราคาเข้าใกล้แนวรับสำคัญและมีสัญญาณขายมากเกินไป', confidence: Math.round(limitBuyConfidence) };
                }
            }
            
            // Trigger 3: Upcoming Limit Buy (Standby)
            if (!signal.active) {
                if (isBtcBullish && rsi < 55 && k < 50 && d < 50 && currentEthPrice > support && (currentEthPrice - support) / support < 0.03) {
                     signal = { active: true, type: 'STANDBY', price: support, reason: 'ราคากำลังย่อตัวเข้าใกล้แนวรับสำคัญ', confidence: 70 };
                }
            }

            // Update UI
            if (signal.active) {
                if (signal.type === 'MARKET') {
                    card.className = "p-6 rounded-2xl border-2 min-h-[250px] flex flex-col items-center justify-center transition-all duration-500 border-green-500 bg-green-900/20";
                    card.innerHTML = `<p class="text-4xl font-bold text-green-300 animate-pulse">เข้าซื้อเลย (Market)</p><p class="text-lg text-gray-300 mt-2">ที่ราคาปัจจุบัน: <span class="font-bold text-white text-xl">~$${signal.price.toLocaleString('en-US', {minimumFractionDigits: 2})}</span></p><p class="text-sm text-gray-400 mt-4">${signal.reason}</p><p class="text-xs text-gray-500 mt-4">ความมั่นใจ: ${signal.confidence}%</p>`;
                } else if (signal.type === 'LIMIT') { 
                    card.className = "p-6 rounded-2xl border-2 min-h-[250px] flex flex-col items-center justify-center transition-all duration-500 border-yellow-500 bg-yellow-900/20";
                    card.innerHTML = `<p class="text-4xl font-bold text-yellow-300">ตั้งซื้อ (Limit)</p><p class="text-lg text-gray-300 mt-2">ที่ราคาแนะนำ: <span class="font-bold text-white text-xl">~$${signal.price.toLocaleString('en-US', {minimumFractionDigits: 2})}</span></p><p class="text-sm text-gray-400 mt-4">${signal.reason}</p><p class="text-xs text-gray-500 mt-4">ความมั่นใจ: ${signal.confidence}%</p>`;
                } else { // STANDBY
                     card.className = "p-6 rounded-2xl border-2 min-h-[250px] flex flex-col items-center justify-center transition-all duration-500 border-blue-500 bg-blue-900/20";
                    card.innerHTML = `<p class="text-3xl font-bold text-blue-300">สัญญาณเข้าซื้อล่วงหน้า</p><p class="text-lg text-gray-300 mt-2">เตรียมตั้งซื้อ (Limit) ที่ราคาเป้าหมาย:</p><p class="font-bold text-white text-4xl mt-2 animate-pulse">~$${signal.price.toLocaleString('en-US', {minimumFractionDigits: 2})}</p><p class="text-sm text-gray-400 mt-4">${signal.reason}</p>`;
                }
            } else {
                let waitingHtml = '';
                if (!isBtcBullish) {
                    card.className = "p-6 rounded-2xl border-2 min-h-[250px] flex flex-col items-center justify-center transition-all duration-500 border-red-700/50";
                    if (nextSupportLevels && nextSupportLevels.length >= 2) {
                        const entry1 = nextSupportLevels[0];
                        const entry2 = nextSupportLevels[1];
                        waitingHtml = `
                            <p class="text-2xl font-bold text-red-400">วางแผนช้อนซื้อช่วงย่อตัว</p>
                            <p class="text-sm text-gray-400 mt-2">ตลาดเป็นขาลง (ความเสี่ยงสูง) แต่สามารถวางแผนเข้าซื้อเพื่อเก็บของได้ที่แนวรับสำคัญถัดไป:</p>
                            <div class="w-full text-left mt-4 space-y-2">
                                <div class="bg-gray-900/50 p-2 rounded-md">
                                    <p class="text-gray-300">ไม้ที่ 1 (30%): <span class="font-bold text-xl text-white float-right">~$${entry1.toLocaleString('en-US', {minimumFractionDigits: 0})}</span></p>
                                </div>
                                <div class="bg-gray-900/50 p-2 rounded-md">
                                    <p class="text-gray-300">ไม้ที่ 2 (70%): <span class="font-bold text-xl text-white float-right">~$${entry2.toLocaleString('en-US', {minimumFractionDigits: 0})}</span></p>
                                </div>
                            </div>
                        `;
                    } else {
                         waitingHtml = `<p class="text-2xl font-bold text-red-400">ชะลอการลงทุน</p><p class="text-sm text-gray-400 mt-2">ตลาดโดยรวมเป็นขาลง และยังไม่พบแนวรับสำคัญที่น่าสนใจในการเข้าซื้อ</p>`;
                    }
                } else if (rsi > 68) {
                    card.className = "p-6 rounded-2xl border-2 min-h-[250px] flex flex-col items-center justify-center transition-all duration-500 border-yellow-700/50";
                    waitingHtml = `<p class="text-2xl font-bold text-yellow-400">เฝ้าระวัง</p><p class="text-sm text-gray-400 mt-2">แนวโน้มยังดี แต่ราคาค่อนข้างสูง (Overbought) รอจังหวะย่อตัว</p>`;
                }
                else {
                    card.className = "p-6 rounded-2xl border-2 min-h-[250px] flex flex-col items-center justify-center transition-all duration-500 border-gray-700";
                    waitingHtml = `<p class="text-2xl font-bold text-gray-500">รอสัญญาณ...</p><p class="text-sm text-gray-600 mt-2">กำลังวิเคราะห์ตลาดเพื่อหาจังหวะเข้าซื้อที่ดีที่สุด</p><div class="loader border-4 border-gray-600 rounded-full w-8 h-8 inline-block mt-4"></div>`;
                }
                 card.innerHTML = waitingHtml;
            }
        }


        function updatePortfolioAnalysis(analysisData) {
            const { rsi, isMacdBullish, isBtcBullish, newsSentimentScore, support, resistance, atr, nextSupportLevels } = analysisData;
            
            const totalEth = transactions.reduce((sum, tx) => sum + tx.amountAfterFee, 0);
            if (totalEth <= 0) return;
            const totalCost = transactions.reduce((sum, tx) => sum + tx.cost, 0);
            const avgPrice = totalCost / totalEth;
            const profitPercent = (currentEthPrice / avgPrice - 1) * 100;
            
            const upsidePrice = resistance;
            const downsidePrice = support;
            
            let bullScore = 0, bearScore = 0;
            if(isBtcBullish) bullScore++; else bearScore++;
            if(isMacdBullish) bullScore++; else bearScore++;
            if(newsSentimentScore > 0) bullScore++; else if(newsSentimentScore < 0) bearScore++;
            bullScore += (50 - rsi) / 25; bearScore += (rsi - 50) / 25;
            let upsideChance = Math.round(50 + (bullScore - bearScore) * 6);
            upsideChance = Math.max(10, Math.min(90, upsideChance));
            
            elements.upsideTarget.textContent = `$${upsidePrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            elements.upsideChance.textContent = `โอกาส ~${upsideChance}%`;
            elements.downsideTarget.textContent = `$${downsidePrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            elements.downsideChance.textContent = `โอกาส ~${100 - upsideChance}%`;

            const atrPerHour = atr / 4; 
            let timeToResistance = 'N/A';
            let timeToSupport = 'N/A';

            if (atrPerHour > 0.1) { 
                const diffToResistance = resistance - currentEthPrice;
                if (diffToResistance > 0) {
                    const hours = Math.min(72, diffToResistance / atrPerHour);
                    timeToResistance = `~${hours.toFixed(1)} ชั่วโมง`;
                }

                const diffToSupport = currentEthPrice - support;
                if (diffToSupport > 0) {
                    const hours = Math.min(72, diffToSupport / atrPerHour);
                    timeToSupport = `~${hours.toFixed(1)} ชั่วโมง`;
                }
            }
            
            elements.upsideTimeEst.textContent = `คาดว่าจะถึงใน: ${timeToResistance}`;
            elements.downsideTimeEst.textContent = `คาดว่าจะถึงใน: ${timeToSupport}`;

            if (nextSupportLevels && nextSupportLevels.length > 0) {
                elements.nextSupportsText.textContent = nextSupportLevels.map(price => `$${price.toLocaleString('en-US', {minimumFractionDigits: 0})}`).join(', ');
                elements.nextSupportLevelsContainer.classList.remove('hidden');
            } else {
                elements.nextSupportLevelsContainer.classList.add('hidden');
            }

            let recText, recReason;
            if (profitPercent > 5 && (rsi > 68 || currentEthPrice > resistance * 0.98)) {
                recText = "พิจารณาแบ่งขายทำกำไร";
                recReason = `มีกำไรและราคาเข้าใกล้แนวต้านสำคัญ ($${resistance.toFixed(0)})`;
            } else if (profitPercent > 0) {
                recText = "ถือต่อเพื่อรันเทรนด์";
                recReason = `พอร์ตยังคงมีกำไร และโมเมตัมตลาดยังดี`;
            } else if (profitPercent > -8) {
                recText = "ถือรอดูสถานการณ์";
                recReason = `ขาดทุนเล็กน้อยและราคายังอยู่เหนือแนวรับ $${support.toFixed(0)}`;
            } else {
                recText = "จัดการความเสี่ยง";
                let nextSupportText = nextSupportLevels && nextSupportLevels.length > 0 ? ` แนวรับถัดไปคือ ~$${Math.round(nextSupportLevels[0])}` : '';
                recReason = `พอร์ตขาดทุน ควรพิจารณาตัดขาดทุนหากราคาหลุดแนวรับ $${support.toFixed(0)}.${nextSupportText}`;
            }
            elements.portfolioRecText.textContent = recText;
            elements.portfolioRecReason.textContent = recReason;
        }

        function addPredictionToHistory(rec, support, resistance) {
            const fifteenMinutes = 15 * 60 * 1000; 
            if (Date.now() - lastPredictionTimestamp < fifteenMinutes) return;

            let predictionType = null, targetPrice = 0;
            if (rec.text.includes('ซื้อเพิ่ม')) {
                predictionType = 'UP';
                targetPrice = resistance;
            } else if (rec.text.includes('ขายทำกำไร')) {
                predictionType = 'DOWN';
                targetPrice = support;
            }

            if (predictionType && targetPrice > 0) {
                predictionHistory.push({
                    id: Date.now(),
                    timestamp: Date.now(),
                    type: predictionType,
                    startPrice: currentEthPrice, 
                    targetPrice: targetPrice,
                    outcome: 'PENDING',
                    resultPrice: 0
                });
                lastPredictionTimestamp = Date.now();
                saveToLocalStorage('eth_prediction_history', predictionHistory);
            }
        }

        async function checkPredictionOutcomes() {
            const fifteenMinutes = 15 * 60 * 1000;
            let historyUpdated = false;

            for (const prediction of predictionHistory) {
                if (prediction.outcome !== 'PENDING') continue;

                const timeElapsed = Date.now() - prediction.timestamp;
                if (timeElapsed < fifteenMinutes) continue; 

                try {
                    const klines = await fetchData(`https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1m&startTime=${prediction.timestamp}&limit=15`);
                    if (klines.length < 15) continue; 

                    const resultPrice = parseFloat(klines[14][4]);
                    prediction.resultPrice = resultPrice;

                    const directionCorrect = 
                        (prediction.type === 'UP' && resultPrice > prediction.startPrice) ||
                        (prediction.type === 'DOWN' && resultPrice < prediction.startPrice);

                    prediction.outcome = directionCorrect ? 'CORRECT' : 'INCORRECT';
                    historyUpdated = true;

                } catch (error) { console.error(`Failed to check outcome for prediction ${prediction.id}`, error); }
            }
            if (historyUpdated) { 
                saveToLocalStorage('eth_prediction_history', predictionHistory); 
                updateAccuracyDisplay(); 
            }
        }

        function updateAccuracyDisplay() {
            const checked = predictionHistory.filter(p => p.outcome === 'CORRECT' || p.outcome === 'INCORRECT');
            let accuracy = null;

            if (checked.length === 0) {
                elements.predictionAccuracyPercent.textContent = "-%";
                elements.predictionAccuracyStats.textContent = "ยังไม่มีข้อมูลคาดการณ์ที่ตรวจสอบแล้ว";
                elements.predictionHistoryList.innerHTML = '';
            } else {
                const correct = checked.filter(p => p.outcome === 'CORRECT').length;
                accuracy = Math.round((correct / checked.length) * 100);
                elements.predictionAccuracyPercent.textContent = `${accuracy}%`;
                elements.predictionAccuracyStats.textContent = `ถูกต้อง ${correct} / ${checked.length} ครั้ง`;

                const recentChecked = checked.slice(-5).reverse();
                let historyHtml = '';
                for (const p of recentChecked) {
                    const isCorrect = p.outcome === 'CORRECT';
                    const startPriceText = `$${p.startPrice.toFixed(2)}`;
                    const resultPriceText = p.resultPrice > 0 ? `$${p.resultPrice.toFixed(2)}` : 'N/A';
                    const targetPriceText = `$${p.targetPrice.toFixed(2)}`;
                    const outcomeText = isCorrect ? '✓ ถูกต้อง' : '✗ ผิดพลาด';
                    const outcomeColor = isCorrect ? 'text-green-400' : 'text-red-400';

                    historyHtml += `
                        <div class="bg-gray-700/50 p-2 rounded-md text-xs">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">ราคาเริ่ม: <span class="font-semibold text-white">${startPriceText}</span></span>
                                <span class="${outcomeColor} font-bold">${outcomeText}</span>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <span class="text-gray-400">เป้าหมาย (${p.type}): <span class="font-semibold text-white">${targetPriceText}</span></span>
                                <span class="text-gray-400">ผลลัพธ์ (15 นาที): <span class="font-semibold text-white">${resultPriceText}</span></span>
                            </div>
                        </div>
                    `;
                }
                elements.predictionHistoryList.innerHTML = historyHtml;
            }
            return accuracy;
        }
        
        function updateShortTermPrediction(oneMinuteKlines) {
            if (!oneMinuteKlines || oneMinuteKlines.length < 15 || currentEthPrice === 0) {
                elements.shortTermPredictionPrice.textContent = '-';
                elements.shortTermPredictionDirection.textContent = 'รอข้อมูล...';
                elements.currentPriceInPrediction.textContent = '-';
                return;
            }
            const closes = oneMinuteKlines.map(k => parseFloat(k[4]));
            const shortTermSMA = calculateSMA(closes, 15);
            
            let predictedPrice, directionText, colorClass;

            if (currentEthPrice > shortTermSMA) {
                predictedPrice = currentEthPrice * 1.0005; 
                directionText = 'มีแนวโน้มปรับตัวขึ้น';
                colorClass = 'text-green-400';
            } else if (currentEthPrice < shortTermSMA) {
                predictedPrice = currentEthPrice * 0.9995;
                directionText = 'มีแนวโน้มปรับตัวลง';
                colorClass = 'text-red-400';
            } else {
                predictedPrice = currentEthPrice;
                directionText = 'มีแนวโน้มทรงตัว';
                colorClass = 'text-yellow-400';
            }
            
            elements.shortTermPredictionPrice.textContent = `$${predictedPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            elements.shortTermPredictionDirection.textContent = directionText;
            elements.shortTermPredictionPrice.className = `text-2xl font-bold ${colorClass}`;
        }

        function formatDateThai(date) {
            const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear() + 543; // Convert to Buddhist Era
            return `${day} ${month} ${year}`;
        }

        function updateAthAnalysis(allTimeKlines, currentPrice) {
             if (!allTimeKlines || allTimeKlines.length === 0 || currentPrice === 0 ) {
                elements.athPrice.textContent = '-';
                elements.resistancePathList.innerHTML = '<div class="text-center text-gray-500">รอข้อมูล...</div>';
                return null;
            }
            
            const weeklyAtr = calculateATR(allTimeKlines);

            const ath = Math.max(...allTimeKlines.map(k => parseFloat(k[2])));
            elements.athPrice.textContent = `$${ath.toLocaleString('en-US', {minimumFractionDigits: 2})}`;

            const potentialResistances = allTimeKlines
                .map(k => parseFloat(k[2])) // High price of each week
                .filter(high => high > currentPrice && high < ath)
                .sort((a, b) => a - b);
            
            const majorResistances = [];
            let lastResistance = currentEthPrice;

            for (const price of potentialResistances) {
                if (price > lastResistance * 1.05) { 
                    majorResistances.push(price);
                    lastResistance = price;
                }
            }
            if (majorResistances.length === 0 || ath > (majorResistances[majorResistances.length - 1] || 0) * 1.05) {
                 majorResistances.push(ath);
            }
           
            let pathHtml = '';

            if(majorResistances.length === 0 || (majorResistances.length === 1 && majorResistances[0] === ath && currentPrice > ath * 0.95)) {
                 pathHtml = '<div class="text-center text-green-400">ไม่มีแนวต้านสำคัญขวางอยู่ก่อนถึง ATH!</div>';
            } else {
                 pathHtml = '';
            }

            for (const resPrice of majorResistances) {
                const isAth = resPrice === ath;
                const priceDiff = resPrice - currentPrice;
                
                let timeEstText = 'N/A';
                if (priceDiff > 0 && weeklyAtr > 0.1) {
                    const weeksToReach = priceDiff / weeklyAtr;
                    const daysToReach = weeksToReach * 7;
                    const targetDate = new Date();
                    targetDate.setDate(targetDate.getDate() + daysToReach);
                    timeEstText = formatDateThai(targetDate);
                }

                pathHtml += `
                    <div class="bg-gray-700/50 p-2 rounded-md text-xs">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300 font-semibold">${isAth ? 'เป้าหมาย All-Time High' : 'แนวต้านถัดไป'}</span>
                            <span class="font-bold text-lg ${isAth ? 'text-yellow-300' : 'text-red-300'}">$${resPrice.toLocaleString('en-US', {minimumFractionDigits: 0})}</span>
                        </div>
                        <div class="text-right text-gray-400 mt-1">
                            คาดว่าจะถึงประมาณ: <span class="font-semibold text-white">${timeEstText}</span>
                        </div>
                    </div>
                `;
            }
            elements.resistancePathList.innerHTML = pathHtml;
            return majorResistances[0] || 0;
        }

        function analyzeTargetPrice() {
            const targetPrice = parseFloat(elements.targetPriceInput.value);

            if (isNaN(targetPrice) || targetPrice <= 0 || !currentAnalysisData.atr || !currentAnalysisData.dailyAtr) {
                elements.targetAnalysisResult.innerHTML = '<p class="text-red-400">กรุณาใส่ราคาที่ถูกต้องและรอให้ข้อมูลวิเคราะห์พร้อมใช้งาน</p>';
                return;
            }

            elements.targetAnalysisResult.innerHTML = '<div class="loader border-4 border-gray-500 rounded-full w-8 h-8 inline-block"></div>';

            setTimeout(() => {
                const { support, dailyAtr } = currentAnalysisData;
                let resultHtml = '';

                if (targetPrice > currentEthPrice) {
                    // Scenario 1: Analyze BUYING now for the target price
                    const potentialGain = targetPrice - currentEthPrice;
                    const potentialLoss = currentEthPrice - support;

                    if (potentialLoss <= 0) {
                        elements.targetAnalysisResult.innerHTML = '<p class="text-yellow-400">ราคาปัจจุบันอยู่ต่ำกว่าแนวรับระยะสั้น จึงมีความเสี่ยงสูง</p>';
                        return;
                    }
                    
                    const riskRewardRatio = potentialGain / potentialLoss;
                    let opinionText, opinionColor;

                    if (riskRewardRatio >= 2.5) {
                        opinionText = 'เห็นด้วยอย่างยิ่ง';
                        opinionColor = 'text-green-400';
                    } else if (riskRewardRatio >= 1.5) {
                        opinionText = 'มีความสมเหตุสมผล';
                        opinionColor = 'text-yellow-400';
                    } else {
                        opinionText = 'มีความเสี่ยงสูง';
                        opinionColor = 'text-red-400';
                    }
                    
                    resultHtml = `
                        <div class="text-left">
                            <p class="text-gray-300">
                                การเข้าซื้อที่ราคาปัจจุบันเพื่อเป้าหมาย
                                <span class="font-bold text-lg text-white">$${targetPrice.toLocaleString()}</span>:
                            </p>
                            <p class="text-4xl font-bold text-center my-2 ${opinionColor}">${opinionText}</p>
                            <p class="text-xs text-gray-500 text-center">
                                *ประเมินจากอัตราส่วนกำไรต่อความเสี่ยง (RR Ratio: ${riskRewardRatio.toFixed(2)})
                            </p>
                        </div>
                    `;

                } else {
                    // Scenario 2: Analyze SELLING now, as price might not drop to target
                    const distanceToTarget = currentEthPrice - targetPrice;
                    const distanceInDailyATR = distanceToTarget / dailyAtr;

                    let probOfDropping = Math.max(5, 100 - (distanceInDailyATR * 75)); // Higher multiplier = harder to reach
                    probOfDropping = Math.min(95, probOfDropping);
                    
                    const probOfNotDropping = 100 - probOfDropping;
                    
                    resultHtml = `
                         <div class="text-left">
                            <p class="text-gray-300">
                                โอกาสที่ราคาจะ <span class="font-bold text-red-400">ไม่ลงไปถึง</span>
                                <span class="font-bold text-lg text-white">$${targetPrice.toLocaleString()}</span>
                                ภายใน 1 วัน คือประมาณ:
                            </p>
                            <p class="text-5xl font-bold text-center my-2 text-purple-400">${probOfNotDropping.toFixed(0)}%</p>
                            <p class="text-xs text-gray-500 text-center">
                                *ยิ่ง % สูง ยิ่งหมายความว่าการขาย ณ ปัจจุบันอาจเป็นตัวเลือกที่ดีกว่าการรอ
                            </p>
                        </div>
                    `;
                }
                
                elements.targetAnalysisResult.innerHTML = resultHtml;

            }, 1000); // Simulate calculation
        }

        function startAccuracyCountdown() {
            clearInterval(accuracyCountdownInterval);
            const totalSeconds = 15 * 60;
            let secondsRemaining = totalSeconds;

            const updateTimer = () => {
                const minutes = String(Math.floor(secondsRemaining / 60)).padStart(2, '0');
                const seconds = String(secondsRemaining % 60).padStart(2, '0');
                
                elements.accuracyCountdown.textContent = `${minutes}:${seconds}`;
                elements.smartRecCountdown.textContent = `${minutes}:${seconds}`;

                const progressPercent = ((totalSeconds - secondsRemaining) / totalSeconds) * 100;
                elements.smartRecProgressBar.style.width = `${progressPercent}%`;
                elements.smartRecProgressText.textContent = `${Math.floor(progressPercent)}%`;
            };

            updateTimer(); 

            accuracyCountdownInterval = setInterval(() => {
                secondsRemaining--;
                if (secondsRemaining < 0) {
                    clearInterval(accuracyCountdownInterval);
                    elements.smartRecProgressBar.style.width = `100%`;
                    elements.smartRecProgressText.textContent = `100%`;
                    return;
                }
                updateTimer();
            }, 1000);
        }


        async function updateAnalysis() {
            try {
                if (currentEthPrice === 0) return; 
                const [ethKlines, btcCloses, eth1mKlines, eth8hKlines, eth15mKlines, ethDailyKlines, allTimeKlines] = await Promise.all([
                    fetchData(`https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=4h&limit=100`),
                    fetchData(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=4h&limit=100`).then(d => d.map(k => parseFloat(k[4]))),
                    fetchData(`https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1m&limit=15`),
                    fetchData(`https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1h&limit=8`),
                    fetchData(`https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=15m&limit=20`),
                    fetchData(`https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1d&limit=100`),
                    fetchAllTimeData()
                ]);
                
                const ethCloses = ethKlines.map(k => parseFloat(k[4]));
                const { support, resistance } = calculateSR(eth8hKlines);
                const atr = calculateATR(ethKlines);
                const dailyAtr = calculateATR(ethDailyKlines);
                
                // Find next support levels
                let nextSupportLevels = [];
                if (allTimeKlines && allTimeKlines.length > 0) {
                    const potentialSupports = allTimeKlines
                        .map(k => parseFloat(k[3])) // k[3] is the low price
                        .filter(low => low < support * 0.98) // Filter for prices significantly lower than current support
                        .sort((a, b) => b - a); // Sort descending

                    let lastSupport = support;
                    for (const price of potentialSupports) {
                        if (price < lastSupport * 0.95 && nextSupportLevels.length < 2) { // At least 5% lower
                            nextSupportLevels.push(price);
                            lastSupport = price;
                        }
                    }
                }

                const btcPrice = btcCloses[btcCloses.length - 1];
                const isBtcBullish = btcPrice > calculateSMA(btcCloses, 20);
                const rsi = calculateRSI(ethCloses);
                const { macd, signal } = calculateMACD(ethCloses);
                const { k, d, j, basePrice } = calculateKDJ(ethKlines);
                const isMacdBullish = macd > signal;
                const sentimentRand = Math.random();
                let newsText, newsScore;
                if(sentimentRand < 0.33) { newsText = 'เชิงลบ 🔻'; newsScore = -1; elements.newsSentiment.className = "font-bold text-lg text-red-400"; } 
                else if (sentimentRand < 0.66) { newsText = 'กลาง 🔸'; newsScore = 0; elements.newsSentiment.className = "font-bold text-lg text-yellow-400"; } 
                else { newsText = 'เชิงบวก 🔺'; newsScore = 1; elements.newsSentiment.className = "font-bold text-lg text-green-400"; }

                elements.btcTrendContainer.innerHTML = `แนวโน้มตลาด (BTC): <span class="${isBtcBullish ? 'text-green-400' : 'text-red-400'} font-semibold">${isBtcBullish ? 'กระทิง 🐂' : 'หมี 🐻'}</span>`;
                elements.supportLevel.textContent = `$${support.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
                elements.resistanceLevel.textContent = `$${resistance.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
                elements.rsiValue.textContent = rsi.toFixed(2);
                elements.macdStatus.className = isMacdBullish ? "font-bold text-lg text-green-400" : "font-bold text-lg text-red-400";
                elements.macdStatus.textContent = isMacdBullish ? 'กระทิง 🐂' : 'หมี 🐻';
                elements.kdjValue.textContent = `${k.toFixed(1)} / ${d.toFixed(1)} / ${j.toFixed(1)}`;
                elements.basePrice.textContent = basePrice > 0 ? `$${basePrice.toLocaleString('en-US', {minimumFractionDigits: 2})}` : 'N/A';
                elements.newsSentiment.textContent = newsText;
                
                const nextMajorResistance = updateAthAnalysis(allTimeKlines, currentEthPrice);
                
                currentAnalysisData = { rsi, isMacdBullish, isBtcBullish, newsSentimentScore: newsScore, support, resistance, atr, dailyAtr, nextSupportLevels, j, k, d, nextMajorResistance, eth15mKlines };
                
                // Update Bear Market Outlook
                if (!isBtcBullish && nextSupportLevels && nextSupportLevels.length >= 1 && nextMajorResistance) {
                    elements.bearMarketOutlookSection.classList.remove('hidden');
                    const bearTarget = nextSupportLevels.length > 1 ? nextSupportLevels[1] : nextSupportLevels[0];
                    elements.bearTargetPrice.textContent = `$${bearTarget.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
                    elements.bullTargetPrice.textContent = `$${nextMajorResistance.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
                } else {
                    elements.bearMarketOutlookSection.classList.add('hidden');
                }

                const rec = getGeneralRecommendation(rsi, isMacdBullish, isBtcBullish, newsScore, currentEthPrice, support, resistance);
                elements.recommendationText.textContent = rec.text;
                elements.recommendationReason.textContent = rec.reason;
                elements.recommendationCard.className = `p-5 rounded-lg border ${rec.style}`;
                
                updatePortfolioAnalysis(currentAnalysisData);
                addPredictionToHistory(rec, support, resistance);
                updateShortTermPrediction(eth1mKlines);
                
                // Update daily range prediction
                if(dailyAtr > 0 && currentEthPrice > 0) {
                    const predictedHigh = currentEthPrice + (dailyAtr * 0.75);
                    const predictedLow = currentEthPrice - (dailyAtr * 0.75);
                    elements.dailyHighPrediction.textContent = `$${predictedHigh.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
                    elements.dailyLowPrediction.textContent = `$${predictedLow.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
                }


                const accuracy = updateAccuracyDisplay();
                getSmartRecommendation(currentAnalysisData, accuracy);
                getTradingRoomSignal(currentAnalysisData);

            } catch (error) { console.error("Could not update analysis:", error); }
        }

        function updateExternalAnalysis() {
            const opinions = [{ text: 'กระทิง 🐂', style: 'text-green-400' }, { text: 'หมี 🐻', style: 'text-red-400' }, { text: 'กลาง 🔸', style: 'text-yellow-400' }];
            const externalOpinion = opinions[Math.floor(Math.random() * opinions.length)];
            const currentAppRecText = elements.recommendationText.textContent;
            let appOpinion = 'กลาง';
            if (currentAppRecText.includes('ซื้อเพิ่ม')) appOpinion = 'กระทิง';
            else if (currentAppRecText.includes('ขายทำกำไร')) appOpinion = 'หมี';

            let status, statusStyle;
            if (externalOpinion.text.includes(appOpinion)) {
                status = 'สอดคล้องกัน';
                statusStyle = 'text-green-400 font-semibold';
            } else {
                status = 'ขัดแย้งกัน';
                statusStyle = 'text-yellow-400 font-semibold';
            }
            elements.externalOpinion.textContent = externalOpinion.text;
            elements.externalOpinion.className = `font-bold text-lg ${externalOpinion.style}`;
            elements.externalStatus.textContent = status;
            elements.externalStatus.className = statusStyle;
            elements.externalLastChecked.textContent = new Date().toLocaleTimeString('th-TH');
        }


        // --- Main Execution ---
        document.addEventListener('DOMContentLoaded', () => {
            transactions = loadFromLocalStorage('eth_transactions');
            predictionHistory = loadFromLocalStorage('eth_prediction_history');

            // Immediately display loaded portfolio data without waiting for price updates
            updatePortfolioDisplay();

            setupWebSocket();
            fetchExchangeRate(); // Fetch on load
            setInterval(fetchExchangeRate, 300000); // Update every 5 minutes

            elements.addTransactionBtn.addEventListener('click', handleAddTransaction);
            elements.resetPortfolioBtn.addEventListener('click', handleResetPortfolio);
            elements.analyzeTargetBtn.addEventListener('click', analyzeTargetPrice);
            elements.modalConfirmBtn.addEventListener('click', () => { if (confirmAction) confirmAction(); });
            elements.modalCancelBtn.addEventListener('click', hideModal);
            
            elements.tabDashboard.addEventListener('click', () => {
                elements.contentDashboard.classList.remove('hidden');
                elements.contentTradingRoom.classList.add('hidden');
                elements.tabDashboard.className = 'border-purple-500 text-purple-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm';
                elements.tabTradingRoom.className = 'border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm';
            });

            elements.tabTradingRoom.addEventListener('click', () => {
                elements.contentDashboard.classList.add('hidden');
                elements.contentTradingRoom.classList.remove('hidden');
                elements.tabTradingRoom.className = 'border-purple-500 text-purple-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm';
                elements.tabDashboard.className = 'border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm';
            });
            
            setTimeout(() => {
                updateAnalysis();
                updateExternalAnalysis();
                
                checkPredictionOutcomes();
                startAccuracyCountdown();

                setInterval(updateAnalysis, 15000);
                setInterval(updateExternalAnalysis, 15 * 60 * 1000);
                
                setInterval(() => {
                    checkPredictionOutcomes();
                    startAccuracyCountdown(); 
                }, 15 * 60 * 1000);
            }, 2000);
        });
    </script>
</body>
</html>